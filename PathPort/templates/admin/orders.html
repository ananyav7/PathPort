<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Monitoring - PathPort Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-shipping-fast"></i> PathPort</h3>
            <p>Admin Panel</p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="{{ url_for('admin_users') }}"><i class="fas fa-users"></i> User Management</a></li>
            <li><a href="{{ url_for('admin_orders') }}" class="active"><i class="fas fa-box"></i> Order Monitoring</a></li>
            <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Content Header -->
        <div class="content-header fade-in">
            <div>
                <h1>Order Monitoring</h1>
                <p>Real-time tracking and management of all parcel deliveries</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span class="status-indicator status-online">Live Updates Active</span>
                <button class="btn btn-primary"><i class="fas fa-sync"></i> Refresh Data</button>
            </div>
        </div>

        <div class="content-wrapper">

            <!-- Order Statistics -->
            <div class="stats-grid">
    <div class="stat-card fade-in">
        <div class="stat-icon"><i class="fas fa-box"></i></div>
        <div class="stat-number">{{ stats.total_active }}</div>
        <div class="stat-label">Total Active Orders</div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-number">{{ stats.pending_assignments }}</div>
        <div class="stat-label">Pending Assignments</div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-icon"><i class="fas fa-truck"></i></div>
        <div class="stat-number">{{ stats.in_transit }}</div>
        <div class="stat-label">In Transit</div>
    </div>
    <div class="stat-card fade-in">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-number">{{ stats.delivered_today }}</div>
        <div class="stat-label">Delivered Today</div>
    </div>
</div>

            <!-- Filter Bar -->
             

            <!-- Orders Table -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3><i class="fas fa-list"></i> All Orders</h3>
                    <div style="display: flex; gap: 0.5rem;">
                         
                         </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table" id="ordersTable">
    <thead>
        <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Route</th>
            <th>Delivery Partner</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for parcel in parcels %}
        <tr data-status="{{ parcel.status }}" data-priority="{{ parcel.urgency }}">
            <td><strong>{{ parcel.order_id or 'N/A' }}</strong></td>
            <td>
                {% if parcel.sender %}
                    {{ parcel.sender.name }}
                {% else %}
                    <span class="text-danger" title="Sender ID: {{ parcel.sender_id }}">Invalid Sender</span>
                {% endif %}
            </td>
            <td>{{ parcel.pickup_location }}<i class="fas fa-long-arrow-alt-right route-arrow"></i>{{ parcel.delivery_location }}</td>
            <td>{{ parcel.delivery_partner.name if parcel.delivery_partner else 'Not Assigned' }}</td>
            <td>
                <span class="status-badge status-{{ parcel.status | lower | replace(' ', '-') | replace('_', '-') }}">
                    {{ parcel.status | replace('_', ' ') | title }}
                </span>
            </td>
            <td>
                 <span class="urgency-badge urgency-{{ parcel.urgency | lower }}">
                    {{ parcel.urgency | title }}
                </span>
            </td>
            <td>{{ parcel.created_at | timeago }}</td>
             <td class="parcel-actions">
    <button class="btn btn-sm btn-info" onclick="viewOrderDetails('{{ parcel._id }}')"><i class="fas fa-eye"></i></button>
</td>
        </tr>
        {% else %}
        <tr>
            <td colspan="8" class="text-center p-4">No orders found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
                </div>
            </div>

            <!-- Real-time Activity Feed -->
            <div class="recent-activity fade-in">
                <h3 style="color: var(--primary-green); margin-bottom: 1.5rem;">
                    <i class="fas fa-broadcast-tower"></i> Live Activity Feed
                </h3>
               <div id="activityFeed">
    {% for activity in activities %}
    <div class="activity-item">
        <div class="activity-icon {{ activity.type }}">
            <i class="fas {{ activity.icon }}"></i>
        </div>
        <div class="activity-content">
            <h4>{{ activity.title }}</h4>
            <p>{{ activity.description }}</p>
        </div>
        <div class="activity-time">{{ activity.timestamp | timeago }}</div>
    </div>
    {% else %}
    <div class="activity-item">
        <div class="activity-icon"><i class="fas fa-history"></i></div>
        <div class="activity-content">
            <h4>No Recent Activity</h4>
            <p>Recent events will be shown here as they happen.</p>
        </div>
    </div>
    {% endfor %}
</div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-box"></i> Order Details</h3>
                <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
            </div>
            <div id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Assign Delivery Partner</h3>
                <span class="close" onclick="closeAssignModal()">&times;</span>
            </div>
            <div style="padding: 1rem;">
                <!-- Assign partner options -->
            </div>
        </div>
    </div>

     

    <!-- Scripts -->
     <script>
    // --- Get all modals ---
    const orderDetailsModal = document.getElementById('orderDetailsModal');
    const orderDetailsContent = document.getElementById('orderDetailsContent');
    const trackingModal = document.getElementById('trackingModal');

    // --- VIEW DETAILS (EYE BUTTON) ---
   function viewOrderDetails(parcelId) {
    orderDetailsModal.style.display = 'block';
    orderDetailsContent.innerHTML = '<p class="text-center">Loading order details...</p>';

    fetch(`/api/admin/parcel-details/${parcelId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                orderDetailsContent.innerHTML = `<p class="text-danger text-center">${data.error}</p>`;
                return;
            }
            
            const parcel = data;

            // --- NEW: Check for an image and create the HTML for it ---
            let imageHtml = '';
            if (parcel.image && parcel.image.data) {
                imageHtml = `
                    <img src="data:${parcel.image.mimetype};base64,${parcel.image.data}" 
                         alt="Parcel Image" 
                         style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 1rem; margin-bottom: 1rem;">
                `;
            }

            let partnerInfo = '<p><strong>Delivery Partner:</strong> Not Assigned</p>';
            if (parcel.delivery_partner) {
                partnerInfo = `
                    <p><strong>Delivery Partner:</strong> ${parcel.delivery_partner.name}</p>
                    <p><strong>Partner Phone:</strong> ${parcel.delivery_partner.phone}</p>
                `;
            }

            // --- Updated innerHTML to include the new imageHtml variable ---
            orderDetailsContent.innerHTML = `
                <h4>Order ID: ${parcel.order_id}</h4>
                <p><strong>Item:</strong> ${parcel.title}</p>
                ${imageHtml} 
                <hr>
                <h5>Sender Details</h5>
                <p><strong>Name:</strong> ${parcel.sender.name}</p>
                <p><strong>Phone:</strong> ${parcel.sender.phone}</p>
                <p><strong>Pickup Address:</strong> ${parcel.pickup_location}</p>
                <hr>
                <h5>Receiver Details</h5>
                <p><strong>Name:</strong> ${parcel.receiver_name}</p>
                <p><strong>Phone:</strong> ${parcel.receiver_phone}</p>
                <p><strong>Delivery Address:</strong> ${parcel.delivery_location}</p>
                <hr>
                <h5>Delivery Info</h5>
                ${partnerInfo}
            `;
        })
        .catch(error => {
            console.error('Error fetching parcel details:', error);
            orderDetailsContent.innerHTML = '<p class="text-danger text-center">Failed to load order details.</p>';
        });
}
    function closeOrderDetailsModal() {
        orderDetailsModal.style.display = 'none';
    }

     
     
</script>

</body>
</html>